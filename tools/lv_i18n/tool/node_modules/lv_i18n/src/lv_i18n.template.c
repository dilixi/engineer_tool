#include "./lv_i18n.h"
#include "stdio.h"

#define SW_LVI18N_PRINT 0

#if SW_LVI18N_PRINT
#include "esp_log.h"
static const char * TAG = "lv_i18n"; 
#define PRINT_LVI18N_PRINT(fmt,args...) ESP_LOGW(TAG,fmt,##args)  
#else
#define PRINT_LVI18N_PRINT(...)
#endif

static lv_i18n_lang_t custom_lang = {
    .locale_name = "custom", 
};

 /*SAMPLE_START*/ 

static lv_i18n_phrase_t en_gb_plurals_other[] = {
    {"p_i_have_dogs", "I have %d dogs"},
    {-1, NULL} // End mark
};

static uint8_t en_gb_plural_fn(int32_t num)
{
    uint32_t n = op_n(num); UNUSED(n);
    uint32_t i = op_i(n); UNUSED(i);
    uint32_t v = op_v(n); UNUSED(v);

    if ((i == 1 && v == 0)) return LV_I18N_PLURAL_TYPE_ONE;
    return LV_I18N_PLURAL_TYPE_OTHER;
}

static const lv_i18n_lang_t en_gb_lang = {
    .locale_name = "en-GB",
    .singulars = en_gb_singulars,
    .plurals[LV_I18N_PLURAL_TYPE_ONE] = en_gb_plurals_one,
    .plurals[LV_I18N_PLURAL_TYPE_OTHER] = en_gb_plurals_other,
    .locale_plural_fn = en_gb_plural_fn
};

static lv_i18n_phrase_t ru_ru_singulars[] = {
    {"s_translated", "s переведено"},
    {-1, NULL} // End mark
};

static lv_i18n_phrase_t ru_ru_plurals_one[] = {
    {"p_i_have_dogs", "У меня %d собакен"},
    {-1, NULL} // End mark
};

static lv_i18n_phrase_t ru_ru_plurals_few[] = {
    {"p_i_have_dogs", "У меня %d собакена"},
    {-1, NULL} // End mark
};

static lv_i18n_phrase_t ru_ru_plurals_many[] = {
    {"p_i_have_dogs", "У меня %d собакенов"},
    {-1, NULL} // End mark
};

static const lv_i18n_lang_t zh_cn_lang = {
    .locale_name = "zh-cn",
    .singulars = zh_cn_singulars,
};

/*SAMPLE_END*/ 
////////////////////////////////////////////////////////////////////////////////

lv_i18n_phrase_t *custom_singulars = NULL;



// Internal state
static const lv_i18n_language_pack_t * current_lang_pack;
static const lv_i18n_lang_t * current_lang; 
static const char *FALL_LANG = "lang not install";
/**
 * Reset internal state. For testing.
 */
void __lv_i18n_reset(void)
{
    current_lang_pack = NULL;
    current_lang = NULL;
}

/**
 * Set the languages for internationalization
 * @param langs pointer to the array of languages. (Last element has to be `NULL`)
 */
int lv_i18n_init(const lv_i18n_language_pack_t * langs)
{
    if(langs == NULL) return -1;
    if(langs[0] == NULL) return -1;

    current_lang_pack = langs;
    current_lang = langs[0];     /*Automatically select the first language*/

    custom_lang.singulars = custom_singulars;
    
    return 0;
}

/**
 * Change the localization (language)
 * @param l_name name of the translation locale to use. E.g. "en-GB"
 */
int lv_i18n_set_locale(const char * l_name)
{
    if (!custom_lang.singulars)
    {
        custom_lang.singulars = custom_singulars;
    }

    if(current_lang_pack == NULL) return -1;

    uint16_t i;

    for(i = 0; current_lang_pack[i] != NULL; i++) {
        // Found -> finish
        if(strcmp(current_lang_pack[i]->locale_name, l_name) == 0) {
            current_lang = current_lang_pack[i];
            return 0;
        }
    }

    return -1;
}


static const char * __lv_i18n_get_text_core(lv_i18n_phrase_t * trans, MLG_KEY_TYPE msg_id)
{
    uint16_t i;
    for(i = 0; trans[i].msg_id != K_INVALID_ID; i++) {
        if(msg_id == trans[i].msg_id) {
            /*The msg_id has found. Check the translation*/
            if(trans[i].translation) return trans[i].translation;
        }
    }

    return NULL;
}


/**
 * Get the translation from a message ID
 * @param msg_id message ID
 * @return the translation of `msg_id` on the set local
 */
const char * lv_i18n_get_text(MLG_KEY_TYPE msg_id)
{
    if(current_lang == NULL) return NULL;

    const lv_i18n_lang_t * lang = current_lang;
    const void * txt=NULL;

    // Search in current locale
    if(lang->singulars != NULL) {

        if (K_NOTIFY_CNT_T == msg_id)
        {
            PRINT_LVI18N_PRINT("get  K_NOTIFY_CNT_T\r\n");
        }  

        txt = __lv_i18n_get_text_core(lang->singulars, msg_id);

        if (txt)
        {
            if (0x0001 == msg_id)
            {
                PRINT_LVI18N_PRINT("locale_name=%s\r\n",lang->locale_name);
                PRINT_LVI18N_PRINT("txt=%s\r\n",(char *)txt);
            } 
        }
        else
        {
            PRINT_LVI18N_PRINT("null txt at[%04x]\r\n",(unsigned int)msg_id);
        }

        if (K_NOTIFY_CNT_T == msg_id)
        {
            PRINT_LVI18N_PRINT("K_NOTIFY_CNT_T txt=%s\r\n",(char *)txt);
        }  

        if (txt != NULL) return txt;
    }

    // Try to fallback
    if(lang == current_lang_pack[0]) return NULL;
    lang = current_lang_pack[0];

    // Repeat search for default locale
    if(lang->singulars != NULL) {
        txt = __lv_i18n_get_text_core(lang->singulars, msg_id);
        if (txt != NULL) return txt;
    }

    return FALL_LANG;
}